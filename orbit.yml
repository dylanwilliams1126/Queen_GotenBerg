tasks:
  
  - use: fmt
    short: Runs go fmt ./...
    run:
      - go fmt ./...

  - use: generate
    short: Generates all files from blueprints
    run:
      - BRANCH="$(git symbolic-ref --short HEAD)"; orbit generate -f _blueprints/README.blueprint.md -o README.md -p "Branch,${BRANCH}"
      - orbit generate -f _blueprints/Dockerfile.blueprint -o Dockerfile.ci -p "Image,CI"
      - orbit generate -f _blueprints/Dockerfile.blueprint -o Dockerfile -p "Image,MAIN"

  - use: ci
    short: Runs CI process inside a container
    run:
      - docker build -t gotenberg:ci -f Dockerfile.ci .
      - docker run --rm -e "VERSION={{ .Orbit.Version }}" -v "$(pwd)/_ci:/go/src/github.com/thecodingmachine/gotenberg/_ci" -v "$(pwd)/_build:/go/src/github.com/thecodingmachine/gotenberg/_build" gotenberg:ci

  - use: build
    short: Builds the main Docker image
    run:
      - docker build . -t gotenberg:{{ .Orbit.Version }}

  - use: up
    short: Starts the {{ .Orbit.Version }} version of the Gotenberg image
    run:
      - docker run --rm -p 3000:3000/tcp gotenberg:{{ .Orbit.Version }}